# Build and publish plugin to a GitHub Release when a release is created.
# The release zip is attached to the release. Plugin manifest is hosted elsewhere (e.g. PluginRepos).

name: Release

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: windows-2022
    permissions:
      contents: write  # upload release asset and update repo

    steps:
      - name: Checkout (tag for build)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Download Dalamud
        run: |
          Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
          New-Item -ItemType Directory -Force "$env:AppData\XIVLauncher\addon\Hooks\dev" | Out-Null
          Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"

      - name: Build
        run: dotnet build EasyPartySort.sln --configuration Release --no-incremental

      - name: Zip plugin
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          $out = "EasyPartySort\bin\x64\Release"
          Compress-Archive -Path "$out\*" -DestinationPath "EasyPartySort-$tag.zip"

      - name: Upload zip to release
        run: gh release upload "${{ github.event.release.tag_name }}" "EasyPartySort-${{ github.event.release.tag_name }}.zip" --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
